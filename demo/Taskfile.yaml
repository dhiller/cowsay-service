version: 3

tasks:
  prepare:
    desc: Prepares the local testing cluster and creates the fortune service targeting the external running vm
    cmds:
    - go-task cluster:up cluster:deploy-kubevirt cluster:deploy-kubevirt-testing-resources
    - kubectl create -f ./manifests/fortune-service-external.yaml
    - kubectl wait deployment --for=condition=available fortune --timeout 5m
    - go-task vm:import-image

  fortune-internal:
    desc: Updates the fortune deployment to point to the internal service running inside the vm that was just imported.
    cmds:
    - kubectl apply -f ./manifests/fortune-service-internal.yaml
    - kubectl wait deployment --for=condition=available fortune --timeout 5m

  port-forward-fortune:
    desc: Adds a looped port forward for the fortune service
    cmds:
    - ./demo/port-forward.sh

  port-forward-prometheus:
    desc: Forward cluster prometheus and grafana
    cmds:
    - ./demo/port-forward-monitoring.sh
